@using MyPortal.Processes
@model MyPortal.ViewModels.RolePermissionsViewModel
@{
    ViewBag.Title = "RolePermissions";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
}

<div class="container mp-page-title">
    <h2>Permissions for @Model.Role.Name Role</h2>
    <hr/>
</div>

<div class="container">
    @Html.EJS().Grid("Permissions").DataSource(d =>
    {
        d.Url($"/api/admin/rolePermissions/get/byRole/dataGrid/{Model.Role.Id}").CrossDomain(false).Adaptor("UrlAdaptor");
    }).Columns(c =>
    {
        c.Field("Permission.Area").HeaderText("Area").Template("#permissionAreaTemplate").Width("200").Add();
        c.Field("Permission.Description").HeaderText("Description").Template("#permissionDescriptionTemplate").Width("300").Add();
        c.Field("HasPermission").HeaderText("Allow").DisplayAsCheckBox(true).Width("100").Add();
        c.HeaderText("Actions").Template("#permissionActionsTemplate").Width("170").Add();
    }).AllowPaging().PageSettings(p => p.PageSize(12)).SearchSettings(s => { s.IgnoreCase(true);}).Toolbar(new List<string> {"Search"}).Render()
</div>

@section scripts
{
    <script>
        $(document).ready(function() {
            $("#Permissions").on("click",
                ".js-toggle",
                function() {
                    var button = $(this);
                    var permissionId = button.attr("data-permission-id");
                    $.ajax({
                        url: "/api/admin/rolePermissions/toggle",
                        method: "POST",
                        data: {roleId: @Model.Role.Id, permissionId: permissionId},
                        success: function (result) {
                            refreshTable("Permissions");
                            toastr.success(result);
                        },
                        error: function(result) {
                            toastr.error(result.responseJSON);
                        }
                    });
                });
        });
    </script>
    
    <script type="text/x-jsrender" id="permissionAreaTemplate">
        <div>
            ${Permission.Area}
        </div>
    </script>
    
    <script type="text/x-jsrender" id="permissionDescriptionTemplate">
        <div>
            ${Permission.Description}
        </div>
    </script>
    
    <script type="text/x-jsrender" id="permissionActionsTemplate">
        <button type="button" class="btn btn-xs btn-warning mp-btn-action js-toggle" data-permission-id="${Permission.Id}">
            <i class="fas fa-check"></i>
        </button>
    </script>
}

